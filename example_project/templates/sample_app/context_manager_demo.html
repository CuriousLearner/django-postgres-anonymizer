{% extends 'base.html' %}

{% block title %}Context Manager Demo - Django PostgreSQL Anonymizer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card mb-4" style="border: 3px solid #28a745; background: linear-gradient(45deg, #f8f9fa, #e9ecef);">
            <div class="card-header" style="background: linear-gradient(45deg, #28a745, #20c997); color: white;">
                <h4 class="mb-0">
                    <i class="fas fa-code me-2"></i>Context Manager Demo
                </h4>
            </div>
            <div class="card-body">
                <p class="lead">
                    This demo shows how to use context managers for temporary anonymized data access.
                </p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Normal Data Access -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-eye me-2"></i>Normal Data Access
                </h5>
            </div>
            <div class="card-body">
                <p class="small text-muted">Direct database queries without anonymization:</p>
                <div class="code-block" style="position: relative;">
                    <pre style="background: #f6f8fa; border: 1px solid #e1e4e8; border-radius: 6px; padding: 16px; margin: 0; font-family: 'SFMono-Regular', Consolas, monospace; font-size: 13px; line-height: 1.45;"><code>User.objects.<span style="color: #6f42c1; font-weight: 600;">values</span>(<span style="color: #032f62;">'username'</span>, <span style="color: #032f62;">'email'</span>)[<span style="color: #005cc5;">:</span><span style="color: #005cc5;">5</span>]</code></pre>
                    <button onclick="copyCode(this)" style="position: absolute; top: 8px; right: 8px; background: #0366d6; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer; opacity: 0.7;" title="Copy code">
                        Copy
                    </button>
                </div>

                <div class="mt-3">
                    {% for user in normal_data %}
                    <div class="border rounded p-2 mb-2 small">
                        <strong>{{ user.username }}</strong><br>
                        <span class="text-muted">{{ user.email }}</span><br>
                        <span>{{ user.first_name }} {{ user.last_name }}</span>
                    </div>
                    {% empty %}
                    <div class="text-muted">No data available</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Anonymized Data Context Manager -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-mask me-2"></i>Anonymized Data
                </h5>
            </div>
            <div class="card-body">
                <p class="small text-muted">Using <code>anonymized_data()</code> context manager:</p>
                <div style="position: relative;">
                    <pre style="background: #f6f8fa; border: 1px solid #e1e4e8; border-radius: 6px; padding: 16px; margin: 0; font-family: 'SFMono-Regular', Consolas, monospace; font-size: 13px; line-height: 1.45;"><code><span style="color: #d73a49; font-weight: 600;">from</span> django_postgres_anon.context_managers <span style="color: #d73a49; font-weight: 600;">import</span> anonymized_data

<span style="color: #d73a49; font-weight: 600;">with</span> <span style="color: #6f42c1;">anonymized_data</span>():
    User.objects.<span style="color: #6f42c1;">values</span>(<span style="color: #032f62;">'username'</span>, <span style="color: #032f62;">'email'</span>)[<span style="color: #005cc5;">:</span><span style="color: #005cc5;">5</span>]</code></pre>
                    <button onclick="copyCode(this)" style="position: absolute; top: 8px; right: 8px; background: #0366d6; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer; opacity: 0.7;" title="Copy code">
                        Copy
                    </button>
                </div>

                <div class="mt-3">
                    {% for user in anonymized_data %}
                        {% if user.error %}
                        <div class="alert alert-warning small">
                            <i class="fas fa-exclamation-triangle me-1"></i>{{ user.error }}
                        </div>
                        {% else %}
                        <div class="border rounded p-2 mb-2 small">
                            <strong>{{ user.username }}</strong><br>
                            <span class="text-muted">{{ user.email }}</span><br>
                            <span>{{ user.first_name }} {{ user.last_name }}</span>
                        </div>
                        {% endif %}
                    {% empty %}
                    <div class="text-muted">No data available</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Database Role Context Manager -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-user-shield me-2"></i>Role Switch
                </h5>
            </div>
            <div class="card-body">
                <p class="small text-muted">Using <code>database_role()</code> context manager:</p>
                <div style="position: relative;">
                    <pre style="background: #f6f8fa; border: 1px solid #e1e4e8; border-radius: 6px; padding: 16px; margin: 0; font-family: 'SFMono-Regular', Consolas, monospace; font-size: 13px; line-height: 1.45;"><code><span style="color: #d73a49; font-weight: 600;">from</span> django_postgres_anon.context_managers <span style="color: #d73a49; font-weight: 600;">import</span> database_role

<span style="color: #d73a49; font-weight: 600;">with</span> <span style="color: #6f42c1;">database_role</span>(<span style="color: #032f62;">'masked_reader'</span>):
    User.objects.<span style="color: #6f42c1;">values</span>(<span style="color: #032f62;">'username'</span>, <span style="color: #032f62;">'email'</span>)[<span style="color: #005cc5;">:</span><span style="color: #005cc5;">5</span>]</code></pre>
                    <button onclick="copyCode(this)" style="position: absolute; top: 8px; right: 8px; background: #0366d6; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer; opacity: 0.7;" title="Copy code">
                        Copy
                    </button>
                </div>

                <div class="mt-3">
                    {% for user in role_switched_data %}
                        {% if user.error %}
                        <div class="alert alert-warning small">
                            <i class="fas fa-exclamation-triangle me-1"></i>{{ user.error }}
                        </div>
                        {% else %}
                        <div class="border rounded p-2 mb-2 small">
                            <strong>{{ user.username }}</strong><br>
                            <span class="text-muted">{{ user.email }}</span><br>
                            <span>{{ user.first_name }} {{ user.last_name }}</span>
                        </div>
                        {% endif %}
                    {% empty %}
                    <div class="text-muted">No data available</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Copy-Paste Section -->
<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header" style="background: linear-gradient(45deg, #17a2b8, #138496); color: white;">
                <h5 class="mb-0">
                    <i class="fas fa-copy me-2"></i>âœ¨ Quick Start - Copy & Paste Ready
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-3">Ready to use this in your project? Copy and paste this code:</p>
                <div style="position: relative;">
                    <pre style="background: #f6f8fa; border: 1px solid #e1e4e8; border-radius: 6px; padding: 16px; margin: 0; font-family: 'SFMono-Regular', Consolas, monospace; font-size: 13px; line-height: 1.45;"><code><span style="color: #6a737d; font-style: italic;"># Import the context managers</span>
<span style="color: #d73a49; font-weight: 600;">from</span> django_postgres_anon.context_managers <span style="color: #d73a49; font-weight: 600;">import</span> anonymized_data, database_role

<span style="color: #6a737d; font-style: italic;"># Basic usage in your views</span>
<span style="color: #d73a49; font-weight: 600;">def</span> <span style="color: #6f42c1;">my_view</span>(request):
    <span style="color: #6a737d; font-style: italic;"># Get anonymized data</span>
    <span style="color: #d73a49; font-weight: 600;">with</span> <span style="color: #6f42c1;">anonymized_data</span>():
        users = User.objects.<span style="color: #6f42c1;">all</span>()

    <span style="color: #6a737d; font-style: italic;"># Or use specific role</span>
    <span style="color: #d73a49; font-weight: 600;">with</span> <span style="color: #6f42c1;">database_role</span>(<span style="color: #032f62;">'masked_reader'</span>):
        customers = Customer.objects.<span style="color: #6f42c1;">all</span>()

    <span style="color: #d73a49; font-weight: 600;">return</span> <span style="color: #6f42c1;">render</span>(request, <span style="color: #032f62;">'template.html'</span>, {<span style="color: #032f62;">'users'</span>: users})</code></pre>
                    <button onclick="copyCode(this)" style="position: absolute; top: 8px; right: 8px; background: #0366d6; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer; opacity: 0.7;" title="Copy code">
                        Copy
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function copyCode(button) {
    const codeBlock = button.previousElementSibling.querySelector('code');
    const text = codeBlock.textContent;

    navigator.clipboard.writeText(text).then(function() {
        const originalText = button.textContent;
        button.textContent = 'Copied!';
        button.style.background = '#28a745';
        button.style.opacity = '1';

        setTimeout(function() {
            button.textContent = originalText;
            button.style.background = '#0366d6';
            button.style.opacity = '0.7';
        }, 2000);
    }).catch(function(err) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);

        const originalText = button.textContent;
        button.textContent = 'Copied!';
        button.style.background = '#28a745';
        button.style.opacity = '1';

        setTimeout(function() {
            button.textContent = originalText;
            button.style.background = '#0366d6';
            button.style.opacity = '0.7';
        }, 2000);
    });
}
</script>
{% endblock %}